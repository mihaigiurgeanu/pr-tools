# PR Tools

A set of command-line tools for managing pull requests in a Git repository. These tools help with creating PR snapshots, sending notifications to Slack, tracking approvals, merging PRs, reviewing changes, and viewing annotated diffs.

Please read the [motivation](https://copilot.microsoft.com/shares/pages/VKL8KZ8pMhsYY68x7TZsr) for a more in-depth info about the purpose of these tools.

## Features

- **pr-snapshot**: Generate a Markdown snapshot of the PR including commits and diff summary.
- **pr-send**: Send the PR snapshot to a Slack channel for review.
- **pr-track**: Track PR approvals and status.
- **pr-merge**: Merge approved PRs with various strategies and update changelog.
- **pr-review**: Interactive code review tool with comment management.
- **pr-view**: View annotated diffs with review comments.
- **pr-fix**: Fix comments received in a review.
- **pr-init**: Interactively generate configuration file for pr-tools.

## Installation

This project is built with Haskell and Cabal. To install:

1. Ensure you have [GHC](https://www.haskell.org/ghc/) and [Cabal](https://www.haskell.org/cabal/) installed. Use [GHCup](https://www.haskell.org/ghcup/) for easy installation.
   - For Windows, you can use the [Haskell Platform](https://www.haskell.org/platform/).
   - For macOS, you can install GHC and Cabal via Homebrew:
     ```
     brew install ghc cabal-install
     ```
2. Clone the repository:
   ```
   git clone <repository-url>
   cd pr-tools
   ```
3. Build and install the executables:
   ```
   cabal update
   cabal install
   ```

This will install the binaries in `~/.cabal/bin` (or equivalent). Add this directory to your PATH if necessary.

## Configuration


### Slack Integration

For `pr-send` and `pr-merge` to post notifications to Slack, add the `slack-webhook` to your `.pr-tools.yaml` file.

- Generate a webhook URL in your Slack workspace: Go to [Slack Apps](https://api.slack.com/apps), create an app, and enable Incoming Webhooks.

If not set, `pr-send` will fail with an error, and `pr-merge` will skip the notification.

### Base Branch and Slack Webhook

Use `pr-init` or manually create a `.pr-tools.yaml` file in the project root with:
```yaml
base-branch: main  # or your default base branch
slack-webhook: "https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX"  # optional Slack webhook URL
```

### Recommended .gitignore Entries

To avoid committing temporary files generated by pr-tools, add the following to your `.gitignore` file:

```
.pr-drafts/
.pr-reviews/
.pr-fixes/
.pr-state.yaml
.pr-tools.yaml  # Optional, if you don't want to commit the config
```

## Usage

### pr-snapshot

Generate a PR snapshot:
```
pr-snapshot [BRANCH] [--base-branch BASE]
```

### pr-send

Send the snapshot to Slack:
```
pr-send [BRANCH]
```

### pr-track

Manage PR tracking:
```
pr-track approve <BRANCH> [--by <NAME>]
pr-track status <BRANCH>
pr-track list
```

### pr-merge

Merge a PR:
```
pr-merge <BRANCH> [--strategy {fast-forward|squash|rebase}] [--base-branch BASE]
```

### pr-review

Manage code reviews:
```
pr-review start
pr-review next
pr-review previous
pr-review open
pr-review files
pr-review changes
pr-review comment --file FILE --line LINE --text "COMMENT"
pr-review resolve --id ID
pr-review end
pr-review list
```

### pr-view

View annotated diff or comments:
```
pr-view diff [BRANCH] [--base-branch BASE] [--full]  # Annotated diff, use --full for full files including unchanged areas
pr-view comments [BRANCH]  # List all comments with context
```

### pr-fix

Manage fix sessions for review comments:
```
pr-fix start
pr-fix comments
pr-fix files
pr-fix open
pr-fix next
pr-fix previous
pr-fix resolve --id ID --status STATUS [--answer "Explanation"]
pr-fix end
pr-fix send
```

### pr-init

Initialize pr-tools configuration interactively:
```
pr-init
```

## Sample Workflow

1. **Create a Feature Branch**: Developer creates a branch, makes changes, and commits.
2. **Generate Snapshot**: Run `pr-snapshot` to create a Markdown description of the PR.
3. **Send to Slack**: Run `pr-send` to notify the team via Slack.
4. **Track Approvals**: Team members approve using `pr-track approve <branch>` or Slack reactions.
5. **Conduct Review**: Reviewer runs `pr-review start`, navigates files with `next`/`open`, adds comments, then `pr-review send` to send compact review to Slack.
6. **Fix Comments**: Developer runs `pr-fix start`, pastes the Slack review message, navigates with `pr-fix next`/`open` to edit files and mark comments (solved/not-solved/will-not-solve), adds answers, or use `pr-fix resolve` for CLI updates, then `pr-fix end` to commit changes, and `pr-fix send` to report back via Slack.
7. **View Annotated Diff**: Anyone can run `pr-view <branch>` to see changes with comments (use --full for full files or `pr-view comments` for comment list).
8. **Merge PR**: Once approved, run `pr-merge <branch>` to merge and update changelog.

This workflow enables collaborative reviews without committing review files to the repo, using Slack for communication.

## Contributing

Contributions are welcome! Please open an issue or submit a pull request.

## License

This project is licensed under the BSD-3-Clause License.
